<!DOCTYPE html>
<html>
<head>
	<title>Password Manager</title>

	{% load static %}
	<script src="{% static '/main/pbkdf2.js' %}"></script>	
	<script src="{% static '/main/aes.js' %}"></script>	
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<link rel="stylesheet" type="text/css" href="{% static '/main/style.css' %}">


</head>
<body>
	<center>
		<div class="loginForm">
			<h1><b>Password Manager<b></h1>
			<br>
			<h2>Register:</h2>
			<br>
			<form method="POST" id="register">
				{% csrf_token %}
				{{ user_create }}
				<input type="button" onclick="p('new');" value="post">
			</form>
			<br>
			<h2>Login:</h2>
			<br>
			<form method="POST" id="login">
				{% csrf_token %}
				{{ user_create }}
				<input type="button" onclick="p('existing');" value="post">
			</form>
			
			<b><h3 id="errorMessage" style="color: red;"></h3></b>
		</div>
	</center>

</body>
<script type="text/javascript">
		function display_vault(){
			//clear page
			var body =  document.getElementsByTagName("BODY")[0];
			body.innerHTML = "";
			var container =  document.createElement("div");
			container.classList.add('container');
			body.appendChild(container);
			//append every saved website to page 
			for (var site in vault){
				container.innerHTML += "<div class=\"row\"><div class=\"col-lg-3 prim\"><b>" + site + "</b></div><div class=\"col-lg-3 sec\">" + vault[site][0] + "</div><div class=\"col-lg-3 prim\">" + vault[site][1] + "</div><div class=\"col-lg-3 sec\">" + vault[site][2] + "</div></div>";
			}
		}


		function encrypt_and_send_vault(){
			const request = new XMLHttpRequest();
			request.open('POST', '/');
			request.setRequestHeader("X-CSRFToken", "{{csrfToken}}");
			const data = new FormData();
		    data.append('type', "change")
    		data.append('Email', mail);
    		data.append('Password', dbKey);
    		updated_vault = JSON.stringify(vault);
    		updated_vault = CryptoJS.AES.encrypt(updated_vault, vaultKey).toString();
    		data.append('Vault', updated_vault);
    		request.send( data );
		}

		function p(type){
			//select form from which data will be read
			if (type == "new"){
				form = document.getElementById("register");
			}
			else{
				form = document.getElementById("login");
			}
		    
		    // Open request
		    const request = new XMLHttpRequest();
		    request.open('POST', '/');
		    
		    // Include csrf token in header so Django will accept the request

		    request.setRequestHeader("X-CSRFToken", "{{csrfToken}}");
		    
		    //get data from form
		    mail = form.children.Email.value;
		    password = form.children.Password.value;
		   
		    //hash (dbKey = Login; vaultKey = en-/decrypt vault)
		    vaultKey = CryptoJS.PBKDF2(password,mail,{keySize: 256 / 32, iterations: 2500}).toString();
		    dbKey = CryptoJS.PBKDF2(vaultKey,password,{keySize: 256 / 32, iterations: 2500}).toString();
    		
    		//save data from form
		    const data = new FormData();
		    data.append('type', type)
    		data.append('Email', mail);
    		data.append('Password', dbKey);
    		
    		if (type == "new"){	//if the account is new then a vault must be created and encrypted aswell
    			//create vault
    			vault = JSON.stringify({});
    			//encrypt vault and turn into string
    			vault = CryptoJS.AES.encrypt(vault, vaultKey).toString();
    			//save vault
    			data.append('Vault', vault);
    		}
		    
		    request.send( data );

		    request.onreadystatechange=(e)=>{
		    	r = request.responseText;
		    	console.log(r);
		    	if (r.substring(0, 6) != "Vault:"){
		    		document.getElementById("errorMessage").innerHTML = r;
		    	}
		    	else{	//if user logged in successfully and got his vault sent back
		    		encrypted_vault = r.substring(6, r.length)
		    		//turn vault back into object
		    		vault_text = CryptoJS.AES.decrypt(encrypted_vault, vaultKey).toString(CryptoJS.enc.Utf8);
		    		vault = JSON.parse(vault_text)
		    		display_vault()
		    	}
		    }
		}

		function add_to_db(url, username, password, name=null){
			if (name == null)
				name = url;
			info = [url, username, password]
			vault[name] = info
			console.log(vault)
			encrypt_and_send_vault()
			display_vault()
		}

		function remove_from_db(name){
			delete vault[name]
			encrypt_and_send_vault()
			display_vault()
		}



		/*
		turn data into vault: 		vault = JSON.stringify({})

		encrypt vault: 				vault = CryptoJS.AES.encrypt(vault, vaultKey)

		turn into string: 			vault = vault.toString()

		decrypt vault: 				vault = CryptoJS.AES.decrypt(vault,vaultKey)

		turn into parsable string: 	vault = vault.toString(CryptoJS.enc.Utf8)

		turn into data: 			vault = JSON.parse(vault)
		*/
		
	</script>
</html>
